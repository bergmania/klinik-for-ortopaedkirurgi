---
import BaseLayout from '../layouts/BaseLayout.astro';
import { i18n } from '../i18n';
import { CONTACT, LOCATION } from '../consts';

const contactForm = i18n.contactForm;

// Structured data for contact page
const contactPageSchema = {
  "@context": "https://schema.org",
  "@type": "ContactPage",
  "name": "Kontakt " + i18n.site.title,
  "description": "Kontakt Klinik for Ortopædkirurgi i Odense",
  "mainEntity": {
    "@type": "MedicalClinic",
    "name": i18n.site.title,
    "telephone": CONTACT.phone,
    "faxNumber": CONTACT.fax,
    "address": {
      "@type": "PostalAddress",
      "streetAddress": CONTACT.address.street,
      "addressLocality": "Odense",
      "postalCode": "5000",
      "addressCountry": "DK"
    }
  }
};
---

<BaseLayout title={i18n.nav.contact} description={i18n.ui.contactPageDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(contactPageSchema)} />

  <section class="page-hero">
    <div class="container">
      <h1>{i18n.nav.contact}</h1>
    </div>
  </section>

  <section class="content">
    <div class="container">
      <div class="contact-grid">
        <div class="contact-info">
          <h2>{i18n.ui.contactInfo}</h2>

          <div class="contact-card" role="region" aria-label={i18n.ui.contactInfo}>
            <div class="contact-item">
              <div class="contact-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
              </div>
              <div>
                <strong id="phone-label">{i18n.common.phone}</strong>
                <a href={`tel:${CONTACT.phone.replace(/\s/g, '')}`} class="phone-link" aria-labelledby="phone-label">{CONTACT.phone}</a>
              </div>
            </div>

            <div class="contact-item">
              <div class="contact-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
              </div>
              <div>
                <strong>{i18n.common.fax}</strong>
                <span>{CONTACT.fax}</span>
              </div>
            </div>

            <div class="contact-item">
              <div class="contact-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </div>
              <div>
                <strong>{i18n.common.address}</strong>
                <address style="font-style: normal;">
                  {CONTACT.address.street}<br>{CONTACT.address.city}
                </address>
                <span class="location-note">{i18n.ui.buildingName}</span>
              </div>
            </div>
          </div>

          <div class="hours-card" role="region" aria-labelledby="hours-title">
            <h3 id="hours-title">{i18n.hours.title}</h3>

            <div class="hours-section">
              <h4>{i18n.hours.phoneHours.title}</h4>
              <p><strong>{i18n.hours.phoneHours.weekdays}</strong></p>
              <p>
                <time datetime="09:00/12:00">{i18n.hours.phoneHours.morning}</time><br>
                <time datetime="13:00/15:00">{i18n.hours.phoneHours.afternoon}</time>
              </p>
            </div>

            <div class="hours-section">
              <h4>{i18n.hours.consultationHours.title}</h4>
              <p><strong>{i18n.hours.consultationHours.weekdays}</strong></p>
              <p>{i18n.hours.consultationHours.note}</p>
            </div>
          </div>

          <div class="holidays-card" role="region" aria-labelledby="holidays-title">
            <h3 id="holidays-title">{i18n.holidays.title}</h3>
            <ul>
              <li><strong>{i18n.holidays.summer.label}:</strong> <time datetime="2025-07-14/2025-08-10">{i18n.holidays.summer.dates}</time></li>
              <li><strong>{i18n.holidays.autumn.label}:</strong> <time datetime="2025-10-13/2025-10-19">{i18n.holidays.autumn.dates}</time></li>
              <li><strong>{i18n.holidays.winter.label}:</strong> <time datetime="2025-12-22/2026-01-04">{i18n.holidays.winter.dates}</time></li>
            </ul>
          </div>

          <div class="documents-card" role="region" aria-labelledby="documents-title">
            <h3 id="documents-title">{i18n.documents.title}</h3>
            <ul class="documents-list">
              <li>
                <a href="/tilsynsrapport-2014.pdf" target="_blank" rel="noopener">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  {i18n.documents.supervisionReport}
                  <span class="file-type">PDF</span>
                </a>
              </li>
              <li>
                <a href="/behandling-af-personoplysninger.pdf" target="_blank" rel="noopener">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  {i18n.documents.personalDataPolicy}
                  <span class="file-type">PDF</span>
                </a>
              </li>
            </ul>
          </div>
        </div>

        <div class="contact-form-section">
          <h2 id="form-title">{contactForm.title}</h2>
          <p class="form-intro">{i18n.ui.formIntro}</p>

          <form id="contact-form" class="contact-form" aria-labelledby="form-title" novalidate>
            <!-- Honeypot field - hidden from users, bots will fill it -->
            <div class="form-group" style="position: absolute; left: -9999px; top: -9999px;" aria-hidden="true">
              <label for="website">Website</label>
              <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
            </div>

            <div class="form-group">
              <label for="name">
                {contactForm.name}
                <span class="required" aria-hidden="true">*</span>
                <span class="sr-only">(påkrævet)</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                autocomplete="name"
                aria-describedby="name-error"
              >
              <span id="name-error" class="error-message" role="alert" hidden></span>
            </div>

            <div class="form-group">
              <label for="email">
                {contactForm.email}
                <span class="required" aria-hidden="true">*</span>
                <span class="sr-only">(påkrævet)</span>
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                autocomplete="email"
                aria-describedby="email-error"
                inputmode="email"
              >
              <span id="email-error" class="error-message" role="alert" hidden></span>
            </div>

            <div class="form-group">
              <label for="phone">{contactForm.phone}</label>
              <input
                type="tel"
                id="phone"
                name="phone"
                autocomplete="tel"
                inputmode="tel"
              >
            </div>

            <div class="form-group">
              <label for="message">
                {contactForm.message}
                <span class="required" aria-hidden="true">*</span>
                <span class="sr-only">(påkrævet)</span>
              </label>
              <textarea
                id="message"
                name="message"
                rows="5"
                required
                aria-describedby="message-error message-hint"
              ></textarea>
              <span id="message-hint" class="field-hint">{i18n.ui.messageHint}</span>
              <span id="message-error" class="error-message" role="alert" hidden></span>
            </div>

            <button type="submit" class="btn btn-primary" id="submit-btn">
              <span class="btn-text">{contactForm.submit}</span>
              <span class="btn-loading" hidden>
                <svg class="spinner" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="20"/>
                </svg>
                {i18n.ui.sending}
              </span>
            </button>
          </form>

          <div id="form-success" class="form-message success" role="status" aria-live="polite" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>{contactForm.success}</span>
          </div>

          <div id="form-error" class="form-message error" role="alert" aria-live="assertive" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>{contactForm.error}</span>
          </div>
        </div>
      </div>

      <div class="map-section" role="region" aria-labelledby="map-title">
        <h2 id="map-title">{i18n.ui.findUs}</h2>
        <p>{i18n.ui.mapDescription}</p>
        <div class="map-container">
          <div id="map" style="height: 400px; border-radius: 12px;"></div>
        </div>
        <noscript>
          <p class="map-fallback">
            <a href={`https://www.openstreetmap.org/?mlat=${LOCATION.lat}&mlon=${LOCATION.lng}#map=${LOCATION.zoom}/${LOCATION.lat}/${LOCATION.lng}`} target="_blank" rel="noopener">
              {i18n.ui.mapFallback}
            </a>
          </p>
        </noscript>
      </div>
    </div>
  </section>
</BaseLayout>

<script define:vars={{
  validation: i18n.contactForm.validation,
  siteTitle: i18n.site.title,
  address: i18n.contact.address,
  location: LOCATION
}}>
  const form = document.getElementById('contact-form');
  const successMessage = document.getElementById('form-success');
  const errorMessage = document.getElementById('form-error');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = submitBtn?.querySelector('.btn-text');
  const btnLoading = submitBtn?.querySelector('.btn-loading');

  // Validation messages from i18n
  const validationMessages = validation;

  // Show field error
  function showError(fieldName, message) {
    const errorEl = document.getElementById(`${fieldName}-error`);
    const input = document.getElementById(fieldName);
    if (errorEl && input) {
      errorEl.textContent = message;
      errorEl.hidden = false;
      input.setAttribute('aria-invalid', 'true');
      input.classList.add('invalid');
    }
  }

  // Clear field error
  function clearError(fieldName) {
    const errorEl = document.getElementById(`${fieldName}-error`);
    const input = document.getElementById(fieldName);
    if (errorEl && input) {
      errorEl.textContent = '';
      errorEl.hidden = true;
      input.removeAttribute('aria-invalid');
      input.classList.remove('invalid');
    }
  }

  // Validate email
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Clear errors on input
  form?.querySelectorAll('input, textarea').forEach(field => {
    field.addEventListener('input', () => {
      clearError(field.id);
    });
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Reset messages
    if (errorMessage) errorMessage.hidden = true;

    // Validate
    let isValid = true;
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const messageInput = document.getElementById('message');

    if (!nameInput.value.trim()) {
      showError('name', validationMessages.name);
      isValid = false;
    }

    if (!emailInput.value.trim() || !isValidEmail(emailInput.value)) {
      showError('email', validationMessages.email);
      isValid = false;
    }

    if (!messageInput.value.trim()) {
      showError('message', validationMessages.message);
      isValid = false;
    }

    if (!isValid) {
      // Focus first invalid field
      const firstInvalid = form.querySelector('[aria-invalid="true"]');
      firstInvalid?.focus();
      return;
    }

    // Show loading state
    if (btnText) btnText.hidden = true;
    if (btnLoading) btnLoading.hidden = false;
    if (submitBtn) submitBtn.setAttribute('disabled', 'true');

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        form.style.display = 'none';
        if (successMessage) {
          successMessage.hidden = false;
          successMessage.focus();
        }
      } else {
        throw new Error('Failed to send');
      }
    } catch (error) {
      if (errorMessage) {
        errorMessage.hidden = false;
        errorMessage.focus();
      }
    } finally {
      // Reset button state
      if (btnText) btnText.hidden = false;
      if (btnLoading) btnLoading.hidden = true;
      if (submitBtn) submitBtn.removeAttribute('disabled');
    }
  });

  // Initialize OpenStreetMap with Leaflet
  const initMap = () => {
    // @ts-ignore
    if (typeof L === 'undefined') return;

    const lat = location.lat;
    const lng = location.lng;

    // @ts-ignore
    const map = L.map('map').setView([lat, lng], location.zoom);

    // @ts-ignore
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(map);

    // @ts-ignore
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(`
      <strong>${siteTitle}</strong><br>
      ${address.street}<br>
      ${address.city}
    `).openPopup();
  };

  // Load Leaflet dynamically
  if (!document.getElementById('leaflet-css')) {
    const link = document.createElement('link');
    link.id = 'leaflet-css';
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
    link.crossOrigin = '';
    document.head.appendChild(link);
  }

  if (!document.getElementById('leaflet-js')) {
    const script = document.createElement('script');
    script.id = 'leaflet-js';
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
    script.crossOrigin = '';
    script.onload = initMap;
    document.body.appendChild(script);
  } else {
    initMap();
  }
</script>

<style>
  .page-hero {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: var(--white);
    padding: 4rem 0;
  }

  .page-hero h1 {
    color: var(--white);
    margin: 0;
  }

  .content {
    padding: 4rem 0;
  }

  .contact-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
  }

  .contact-info h2,
  .contact-form-section h2 {
    margin-bottom: 1.5rem;
    color: var(--primary-dark);
  }

  .contact-card {
    background: rgba(var(--gray-light), 0.5);
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  .contact-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .contact-item:last-child {
    margin-bottom: 0;
  }

  .contact-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--primary);
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .contact-item strong {
    display: block;
    font-size: 0.85rem;
    color: rgb(var(--gray));
    margin-bottom: 0.25rem;
  }

  .contact-item span,
  .contact-item address {
    display: block;
  }

  .location-note {
    font-size: 0.9rem;
    color: rgb(var(--gray));
    margin-top: 0.25rem;
  }

  .hours-card,
  .holidays-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--box-shadow);
    margin-bottom: 1.5rem;
  }

  .hours-card h3,
  .holidays-card h3 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: var(--primary-dark);
  }

  .hours-section {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(var(--gray), 0.1);
  }

  .hours-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .hours-section h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.95rem;
    color: var(--primary);
  }

  .hours-section p {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
  }

  .holidays-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .holidays-card li {
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(var(--gray), 0.1);
  }

  .holidays-card li:last-child {
    border-bottom: none;
  }

  .documents-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--box-shadow);
  }

  .documents-card h3 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: var(--primary-dark);
  }

  .documents-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .documents-list li {
    margin-bottom: 0.75rem;
  }

  .documents-list li:last-child {
    margin-bottom: 0;
  }

  .documents-list a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: rgba(var(--gray-light), 0.5);
    border-radius: 8px;
    color: rgb(var(--gray-dark));
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .documents-list a:hover {
    background: var(--primary);
    color: var(--white);
  }

  .documents-list a svg {
    flex-shrink: 0;
  }

  .file-type {
    margin-left: auto;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.2rem 0.5rem;
    background: rgba(var(--gray), 0.15);
    border-radius: 4px;
  }

  .documents-list a:hover .file-type {
    background: rgba(255, 255, 255, 0.2);
  }

  .form-intro {
    color: rgb(var(--gray));
    margin-bottom: 1.5rem;
  }

  .contact-form {
    background: rgba(var(--gray-light), 0.3);
    padding: 2rem;
    border-radius: 12px;
  }

  .required {
    color: #c0392b;
  }

  .field-hint {
    display: block;
    font-size: 0.85rem;
    color: rgb(var(--gray));
    margin-top: 0.25rem;
  }

  .error-message {
    display: block;
    font-size: 0.85rem;
    color: #c0392b;
    margin-top: 0.25rem;
  }

  input.invalid,
  textarea.invalid {
    border-color: #c0392b;
  }

  input.invalid:focus,
  textarea.invalid:focus {
    box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
  }

  .btn-loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-loading:not([hidden]) {
    display: inline-flex;
  }

  .spinner {
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .form-message {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 1rem;
  }

  .form-message svg {
    flex-shrink: 0;
  }

  .form-message.success {
    background: rgba(39, 174, 96, 0.1);
    color: #1e8449;
    border: 1px solid rgba(39, 174, 96, 0.3);
  }

  .form-message.error {
    background: rgba(231, 76, 60, 0.1);
    color: #c0392b;
    border: 1px solid rgba(231, 76, 60, 0.3);
  }

  .form-message[hidden] {
    display: none;
  }

  .map-section {
    margin-top: 4rem;
  }

  .map-section h2 {
    margin-bottom: 0.5rem;
  }

  .map-section > p {
    color: rgb(var(--gray));
    margin-bottom: 1.5rem;
  }

  @media (max-width: 768px) {
    .contact-grid {
      grid-template-columns: 1fr;
      gap: 3rem;
    }
  }
</style>
